{% set tmp_sudoers = '/tmp/sudoers' %}
{% set sudoers = '/etc/sudoers' %}

sudoers_backup:
  file.copy:
    - name: {{ tmp_sudoers }}
    - source: {{ sudoers }}
    - unless: cat {{ sudoers }} | grep adm

sudoers_append:
  file.append:
    - name: {{ tmp_sudoers }}
    - text: |
        adm ALL=(ALL) NOPASSWD: /usr/sbin/crm_attribute -n hana__site_srHook_*
    - require:
      - sudoers_backup

sudoers_check:
  cmd.run:
    - name: /usr/sbin/visudo -c -f {{ tmp_sudoers }}
    - require:
      - sudoers_append

sudoers_edit:
  file.copy:
    - name: {{ sudoers }}
    - source: {{ tmp_sudoers }}
    - force: true
    - require:
      - sudoers_check
